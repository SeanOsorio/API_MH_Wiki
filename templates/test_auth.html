<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración - MonsterHunterWiki</title>
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3a5f 0%, #2c5282 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px;
            text-align: center;
        }
        
        .header h1 {
            color: #2c5282;
            margin-bottom: 10px;
            font-size: 32px;
        }
        
        .header p {
            color: #666;
            font-size: 16px;
        }
        
        .back-btn {
            display: inline-block;
            margin-bottom: 20px;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateX(-5px);
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .test-box {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
        }
        
        .test-box:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .test-box h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 20px;
        }
        
        .test-box p {
            color: #666;
            margin-bottom: 15px;
            line-height: 1.6;
        }
        
        button {
            width: 100%;
            background: linear-gradient(135deg, #2c5282 0%, #1e3a5f 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            margin-bottom: 10px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(44, 82, 130, 0.4);
        }
        
        button.secondary {
            background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
        }
        
        button.secondary:hover {
            box-shadow: 0 5px 15px rgba(74, 85, 104, 0.4);
        }
        
        #result {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #2c5282;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 500px;
            overflow-y: auto;
            line-height: 1.6;
            font-size: 13px;
        }
        
        .success { 
            background: #d4edda; 
            color: #155724;
            border-color: #c3e6cb;
        }
        
        .error { 
            background: #f8d7da; 
            color: #721c24;
            border-color: #f5c6cb;
        }
        
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border-color: #bee5eb;
        }
        
        /* Modal de CAPTCHA */
        .captcha-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .captcha-modal.active {
            display: flex;
        }
        
        .captcha-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            max-width: 450px;
            width: 90%;
        }
        
        .captcha-content h3 {
            color: #2c5282;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .captcha-content p {
            color: #666;
            margin-bottom: 20px;
            text-align: center;
            font-size: 14px;
        }
        
        .recaptcha-container {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }
        
        .captcha-buttons {
            display: flex;
            gap: 10px;
        }
        
        .captcha-buttons button {
            flex: 1;
            margin: 0;
        }
        
        .captcha-error {
            color: #dc3545;
            text-align: center;
            margin-bottom: 15px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/" class="back-btn">← Volver a la Wiki</a>
        
        <div class="header">
            <h1>Panel de Administración</h1>
            <p>Pruebas del Sistema de Autenticación y Gestión</p>
        </div>
        
        <div class="grid">
            <div class="test-box">
                <h2>Test de Autenticación</h2>
                <p>Prueba el sistema de login y registro</p>
                <button onclick="testLogin()">Probar Login Admin</button>
                <button onclick="testRegister()" class="secondary">Probar Registro</button>
            </div>
            
            <div class="test-box">
                <h2>Gestión de Usuarios</h2>
                <p>Ver todos los usuarios registrados</p>
                <button onclick="listUsers()">Listar Usuarios</button>
                <button onclick="getUserProfile()" class="secondary">Mi Perfil</button>
            </div>
            
            <div class="test-box">
                <h2>Estadísticas</h2>
                <p>Ver estadísticas del sistema</p>
                <button onclick="getStats()">Ver Estadísticas</button>
                <button onclick="getHealth()" class="secondary">Health Check</button>
            </div>
            
            <div class="test-box">
                <h2>Armas y Categorías</h2>
                <p>Gestión de contenido de la wiki</p>
                <button onclick="listCategories()">Ver Categorías</button>
                <button onclick="listWeapons()" class="secondary">Ver Armas</button>
            </div>
            
            <div class="test-box">
                <h2>Sistema</h2>
                <p>Información del sistema</p>
                <button onclick="testAllEndpoints()">Test Todos los Endpoints</button>
                <button onclick="clearResults()" class="secondary">Limpiar Consola</button>
            </div>
            
            <div class="test-box">
                <h2>Acciones Rápidas</h2>
                <p>Navegación y utilidades</p>
                <button onclick="window.location.href='/'">Ir a la Wiki</button>
                <button onclick="window.location.href='/weapons'" class="secondary">Ver Armas</button>
            </div>
        </div>
        
        <div class="test-box" style="background: white;">
            <h2 style="color: #333; margin-bottom: 20px;">Consola de Resultados</h2>
            <div id="result" class="info">Esperando comandos... Haz clic en cualquier botón para ejecutar pruebas.</div>
        </div>
    </div>

    <!-- Modal de CAPTCHA -->
    <div id="captchaModal" class="captcha-modal">
        <div class="captcha-content">
            <h3>Verificación de Seguridad</h3>
            <p>Por favor completa el reCAPTCHA para continuar</p>
            <div id="captchaError" class="captcha-error" style="display: none;"></div>
            <div class="recaptcha-container">
                <div class="g-recaptcha" data-sitekey="6LeIxAcTAAAAAJcZVRqyHh71UMIEGNQ_MXjiZKhI"></div>
            </div>
            <div class="captcha-buttons">
                <button onclick="verifyCaptcha()" style="background: linear-gradient(135deg, #28a745 0%, #20853a 100%);">Verificar</button>
                <button onclick="closeCaptcha()" class="secondary">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        let adminToken = localStorage.getItem('mh_token');
        let captchaCallback = null;
        
        function showResult(message, type = 'info') {
            const result = document.getElementById('result');
            result.textContent = message;
            result.className = type;
        }
        
        if (adminToken) {
            showResult('[INFO] Token detectado. Listo para usar endpoints autenticados.', 'info');
        }

        // Mostrar modal de CAPTCHA
        function showCaptcha(callback) {
            captchaCallback = callback;
            document.getElementById('captchaError').style.display = 'none';
            document.getElementById('captchaModal').classList.add('active');
            // Resetear reCAPTCHA si ya fue usado
            if (typeof grecaptcha !== 'undefined') {
                grecaptcha.reset();
            }
        }

        // Cerrar modal
        function closeCaptcha() {
            document.getElementById('captchaModal').classList.remove('active');
            captchaCallback = null;
            showResult('[INFO] Verificación cancelada.', 'info');
        }

        // Verificar CAPTCHA
        function verifyCaptcha() {
            const recaptchaResponse = grecaptcha.getResponse();
            
            if (!recaptchaResponse) {
                document.getElementById('captchaError').textContent = 'Por favor completa el reCAPTCHA';
                document.getElementById('captchaError').style.display = 'block';
                return;
            }
            
            document.getElementById('captchaModal').classList.remove('active');
            showResult('[OK] reCAPTCHA verificado correctamente.', 'success');
            
            if (captchaCallback) {
                captchaCallback();
            }
        }

        // Función de login con CAPTCHA
        function testLogin() {
            showCaptcha(async function() {
                showResult('Probando login...', 'info');
                try {
                    const response = await fetch('/api/auth/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username: 'admin', password: 'qwertyuiop+' })
                    });
                    const data = await response.json();
                    if (response.ok) {
                        adminToken = data.token;
                        localStorage.setItem('mh_token', data.token);
                        showResult(
                            '[OK] LOGIN EXITOSO!\n\n' +
                            'Usuario: ' + data.user.username + '\n' +
                            'Rol: ' + data.user.role + '\n' +
                            'Email: ' + data.user.email + '\n' +
                            'Token guardado correctamente.',
                            'success'
                        );
                    } else {
                        showResult('[ERROR] ' + (data.error || 'Error desconocido'), 'error');
                    }
                } catch (error) {
                    showResult('[ERROR] ' + error.message, 'error');
                }
            });
        }

        // Función de registro con CAPTCHA
        function testRegister() {
            showCaptcha(async function() {
                showResult('Probando registro...', 'info');
                try {
                    const testUser = {
                        username: 'testuser_' + Date.now(),
                        email: 'test' + Date.now() + '@example.com',
                        password: 'password123'
                    };
                    const response = await fetch('/api/auth/register', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(testUser)
                    });
                    const data = await response.json();
                    if (response.ok) {
                        showResult('[OK] REGISTRO EXITOSO!\n\nUsuario: ' + testUser.username, 'success');
                    } else {
                        showResult('[ERROR] ' + (data.error || 'Error desconocido'), 'error');
                    }
                } catch (error) {
                    showResult('[ERROR] ' + error.message, 'error');
                }
            });
        }

        async function listUsers() {
            if (!adminToken) {
                showResult('AVISO: Necesitas iniciar sesión primero.', 'error');
                return;
            }
            showResult('Cargando usuarios...', 'info');
            try {
                const response = await fetch('/api/auth/users', {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });
                const data = await response.json();
                if (response.ok) {
                    let output = '[LISTA DE USUARIOS]\n\nTotal: ' + data.total + ' usuarios\n' + '─'.repeat(60) + '\n\n';
                    data.users.forEach((user, i) => {
                        output += `${i+1}. ${user.username}\n   Email: ${user.email}\n   Rol: ${user.role}\n   Estado: ${user.is_active ? 'Activo' : 'Inactivo'}\n\n`;
                    });
                    showResult(output, 'success');
                } else {
                    showResult('[ERROR] ' + (data.error || 'No autorizado'), 'error');
                }
            } catch (error) {
                showResult('[ERROR] ' + error.message, 'error');
            }
        }

        async function getUserProfile() {
            if (!adminToken) {
                showResult('AVISO: Necesitas iniciar sesión primero.', 'error');
                return;
            }
            try {
                const response = await fetch('/api/auth/me', {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });
                const data = await response.json();
                if (response.ok) {
                    showResult(
                        '[MI PERFIL]\n\n' +
                        'Usuario: ' + data.user.username + '\n' +
                        'Email: ' + data.user.email + '\n' +
                        'Rol: ' + data.user.role + '\n' +
                        'Estado: ' + (data.user.is_active ? 'Activo' : 'Inactivo'),
                        'success'
                    );
                } else {
                    showResult('[ERROR] ' + (data.error || 'No autorizado'), 'error');
                }
            } catch (error) {
                showResult('[ERROR] ' + error.message, 'error');
            }
        }
        
        async function getStats() {
            try {
                const response = await fetch('/api/auth/stats', {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });
                const data = await response.json();
                showResult(
                    '[ESTADÍSTICAS]\n\n' +
                    'Categorías: ' + data.total_categories + '\n' +
                    'Armas: ' + data.total_weapons + '\n' +
                    'Artículos: ' + data.total_articles,
                    'success'
                );
            } catch (error) {
                showResult('[ERROR] ' + error.message, 'error');
            }
        }
        
        async function getHealth() {
            try {
                const response = await fetch('/health');
                const data = await response.json();
                showResult('[HEALTH CHECK]\n\nEstado: ' + data.status + '\nDB: ' + data.database, 'success');
            } catch (error) {
                showResult('[ERROR] ' + error.message, 'error');
            }
        }
        
        async function listCategories() {
            try {
                const response = await fetch('/api/categories');
                const data = await response.json();
                let output = '[CATEGORÍAS]\n\nTotal: ' + data.length + '\n\n';
                data.forEach((cat, i) => {
                    output += `${i+1}. ${cat.name}\n   ID: ${cat.id}\n   Armas: ${cat.weapon_count}\n\n`;
                });
                showResult(output, 'success');
            } catch (error) {
                showResult('[ERROR] ' + error.message, 'error');
            }
        }
        
        async function listWeapons() {
            try {
                const response = await fetch('/api/weapons');
                const data = await response.json();
                let output = '[ARMAS]\n\nTotal: ' + data.length + '\n\n';
                data.slice(0, 10).forEach((w, i) => {
                    output += `${i+1}. ${w.name}\n   Ataque: ${w.attack_power || 'N/A'}\n\n`;
                });
                if (data.length > 10) output += `... y ${data.length - 10} más\n`;
                showResult(output, 'success');
            } catch (error) {
                showResult('[ERROR] ' + error.message, 'error');
            }
        }
        
        async function testAllEndpoints() {
            const tests = [
                { name: 'GET /api/categories', url: '/api/categories' },
                { name: 'GET /api/weapons', url: '/api/weapons' },
                { name: 'GET /health', url: '/health' }
            ];
            let results = '[TEST DE ENDPOINTS]\n\n';
            for (const test of tests) {
                try {
                    const start = Date.now();
                    const response = await fetch(test.url);
                    const time = Date.now() - start;
                    results += `${response.ok ? '[OK]' : '[FAIL]'} ${test.name} (${time}ms)\n`;
                } catch (error) {
                    results += `[FAIL] ${test.name} - ${error.message}\n`;
                }
            }
            showResult(results, 'success');
        }
        
        function clearResults() {
            showResult('Consola limpiada.', 'info');
        }
    </script>
</body>
</html>
